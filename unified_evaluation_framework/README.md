# ç»Ÿä¸€è¯„ä¼°æ¡†æ¶ (Unified Evaluation Framework)

ä¸€ä¸ªç”¨äºæ·±åº¦ä¼°è®¡å’Œä½å§¿ä¼°è®¡çš„ç»Ÿä¸€è¯„ä¼°æ¡†æ¶ï¼Œç¡®ä¿ä¸åŒæ¨¡å‹ä½¿ç”¨ç›¸åŒçš„è¯„ä¼°æ ‡å‡†å’Œæµç¨‹ã€‚

## ğŸ¯ ç‰¹æ€§

### æ·±åº¦è¯„ä¼°
- **æ ‡å‡†åŒ–æµç¨‹**: ä¸¥æ ¼æŒ‰ç…§ç»Ÿä¸€æ ‡å‡†ï¼ˆè°ƒæ•´å°ºå¯¸â†’æœ‰æ•ˆæ©ç â†’ä¸­å€¼ç¼©æ”¾â†’èŒƒå›´æˆªæ–­â†’è¯¯å·®è®¡ç®—ï¼‰
- **æœ‰æ•ˆèŒƒå›´**: 1e-3åˆ°150ç±³çš„æ·±åº¦èŒƒå›´è¿‡æ»¤
- **ä¸­å€¼ç¼©æ”¾å¯¹é½**: å¤„ç†ç›¸å¯¹æ·±åº¦vsç»å¯¹æ·±åº¦çš„å°ºåº¦é—®é¢˜
- **å¤šç§æŒ‡æ ‡**: abs_rel, sq_rel, rmse, rmse_log, a1, a2, a3

### ä½å§¿è¯„ä¼°
- **G-ATE (å…¨å±€ATE)**: èµ·å§‹å¸§å¯¹é½ + æœ€å°äºŒä¹˜æ³•å°ºåº¦ä¼°è®¡ + å…¨å±€RMSEè®¡ç®—
- **L-ATE (å±€éƒ¨ATE)**: ä¸é‡å 5å¸§çª—å£ + æ¯çª—å£ç‹¬ç«‹å¯¹é½ + RMSEç»Ÿè®¡ (meanÂ±std)
- **ä¸¥æ ¼å¯¹é½**: ç¡®ä¿èµ·å§‹å¸§å¯¹é½ + å°ºåº¦ç¼©æ”¾åä»ä¿æŒèµ·ç‚¹å¯¹é½
- **ç»Ÿä¸€å•ä½**: è¾“å…¥è¾“å‡ºä½ç§»å•ä½ç»Ÿä¸€ä¸ºç±³(m)

### æ•°æ®æ ¼å¼å…¼å®¹
- **æ·±åº¦æ ¼å¼**: npy_dir, npz_file, tiff_dir
- **ä½å§¿æ ¼å¼**: npz_dir, npz_file, txt_file, json_file  
- **è‡ªåŠ¨é€‚é…**: æ”¯æŒmm/må•ä½è½¬æ¢ï¼Œå¤šç§æ•°æ®ç»“æ„è‡ªåŠ¨è¯†åˆ«
- **æ•°æ®éªŒè¯**: è¾“å…¥æ•°æ®è´¨é‡æ£€æŸ¥å’Œè­¦å‘Š

## ğŸ“¦ æ¡†æ¶ç»“æ„

```
unified_evaluation_framework/
â”œâ”€â”€ core/                     # æ ¸å¿ƒè¯„ä¼°æ¨¡å—
â”‚   â”œâ”€â”€ depth_evaluator.py   # æ·±åº¦è¯„ä¼°å™¨
â”‚   â”œâ”€â”€ pose_evaluator.py    # ä½å§¿è¯„ä¼°å™¨
â”‚   â””â”€â”€ utils.py             # é€šç”¨å·¥å…·å‡½æ•°
â”œâ”€â”€ adapters/                 # æ•°æ®æ ¼å¼é€‚é…å™¨
â”‚   â”œâ”€â”€ depth_adapter.py     # æ·±åº¦æ•°æ®é€‚é…å™¨
â”‚   â””â”€â”€ pose_adapter.py      # ä½å§¿æ•°æ®é€‚é…å™¨
â”œâ”€â”€ evaluators/               # ç»Ÿä¸€è¯„ä¼°æ¥å£
â”‚   â””â”€â”€ unified_evaluator.py # ç»Ÿä¸€è¯„ä¼°å™¨
â”œâ”€â”€ examples/                 # ä½¿ç”¨ç¤ºä¾‹
â”‚   â””â”€â”€ evaluation_examples.py
â”œâ”€â”€ configs/                  # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ default_config.json
â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```python
from evaluators import UnifiedEvaluator

# åˆå§‹åŒ–è¯„ä¼°å™¨
evaluator = UnifiedEvaluator(
    depth_min=1e-3,      # æ·±åº¦èŒƒå›´: 1mm ~ 150m
    depth_max=150.0,
    pose_window_size=5,  # L-ATEçª—å£: 5å¸§ä¸é‡å 
    verbose=True
)

# å®Œæ•´è¯„ä¼° (æ·±åº¦ + ä½å§¿)
results = evaluator.evaluate_complete(
    gt_depth_path="/path/to/gt_depths.npz",
    pred_depth_path="/path/to/predicted_depths/",
    gt_pose_path="/path/to/gt_poses.npz",
    pred_pose_path="/path/to/predicted_poses/",
    output_dir="/path/to/results/",
    # æ·±åº¦é…ç½®
    gt_depth_format='npz_file',
    pred_depth_format='npy_dir',
    gt_depth_unit='m',
    pred_depth_unit='m',
    # ä½å§¿é…ç½®  
    gt_pose_format='npz_file',
    pred_pose_format='npz_dir',
    gt_pose_unit='m',
    pred_pose_unit='m'
)

# æ‰“å°ç»“æœ
evaluator.print_complete_results(results)
```

### ä»…æ·±åº¦è¯„ä¼°

```python
depth_results = evaluator.evaluate_depth_only(
    gt_depth_path="/path/to/gt_depths.npz",
    pred_depth_path="/path/to/predicted_depths/",
    gt_format='npz_file',
    pred_format='npy_dir',
    gt_unit='m',
    pred_unit='m'
)
```

### ä»…ä½å§¿è¯„ä¼°

```python
pose_results = evaluator.evaluate_pose_only(
    gt_pose_path="/path/to/gt_poses.npz",
    pred_pose_path="/path/to/predicted_poses/",
    gt_format='npz_file', 
    pred_format='npz_dir',
    gt_unit='m',
    pred_unit='m'
)
```

## ğŸ“Š æ”¯æŒçš„æ•°æ®æ ¼å¼

### æ·±åº¦æ•°æ®æ ¼å¼

| æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `npy_dir` | NPYæ–‡ä»¶ç›®å½•ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸€å¸§æ·±åº¦ | `depth_000001.npy`, `depth_000002.npy` |
| `npz_file` | å•ä¸ªNPZæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å¸§ | `all_depths.npz` (key: 'data' æˆ– 'depths') |
| `tiff_dir` | TIFFæ–‡ä»¶ç›®å½•ï¼Œé€‚ç”¨äºSCAREDæ•°æ®é›† | `scene_points00001.tiff` |

### ä½å§¿æ•°æ®æ ¼å¼

| æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `npz_dir` | NPZæ–‡ä»¶ç›®å½•ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸€ä¸ª4x4ä½å§¿çŸ©é˜µ | `pose_000001.npz` |
| `npz_file` | å•ä¸ªNPZæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ä½å§¿ | `all_poses.npz` (key: 'data' æˆ– 'poses') |
| `txt_file` | æ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œ16ä¸ªå…ƒç´ æˆ–12ä¸ªå…ƒç´ (KITTI) | `poses.txt` |
| `json_file` | JSONæ ¼å¼æ–‡ä»¶ | `poses.json` |

## ğŸ¯ è¯„ä¼°æ ‡å‡†

### æ·±åº¦è¯„ä¼°æµç¨‹
1. **è°ƒæ•´åˆ°GTå°ºå¯¸**: å°†é¢„æµ‹æ·±åº¦resizeåˆ°GTå°ºå¯¸
2. **åˆ›å»ºæœ‰æ•ˆæ©ç **: 1e-3åˆ°150mèŒƒå›´ï¼Œæ’é™¤æ— æ•ˆåƒç´ 
3. **ä¸­å€¼ç¼©æ”¾å¯¹é½**: `ratio = GTä¸­å€¼ / é¢„æµ‹ä¸­å€¼`
4. **æ·±åº¦èŒƒå›´æˆªæ–­**: é™åˆ¶é¢„æµ‹æ·±åº¦æå€¼
5. **è®¡ç®—è¯¯å·®æŒ‡æ ‡**: abs_rel, sq_rel, rmse, rmse_log, a1, a2, a3

### ä½å§¿è¯„ä¼°æµç¨‹

#### G-ATE (å…¨å±€ATE)
1. èµ·å§‹å¸§å¯¹é½: `pred[0] = gt[0]`
2. æœ€å°äºŒä¹˜æ³•ä¼°è®¡å°ºåº¦å› å­
3. åº”ç”¨ç¼©æ”¾å¹¶ä¿è¯èµ·ç‚¹ä»å¯¹é½
4. è®¡ç®—å…¨å±€ATEçš„RMSE

#### L-ATE (å±€éƒ¨ATE) 
1. ä¸é‡å çª—å£åˆ†å‰²: 0-4, 5-9, 10-14...
2. æ¯ä¸ªçª—å£æ‰§è¡ŒG-ATEç›¸åŒæµç¨‹
3. è®¡ç®—æ¯ä¸ªçª—å£çš„ATE RMSE
4. æ±‡æ€»æ‰€æœ‰çª—å£RMSEçš„meanå’Œstd

## ğŸ“ˆ è¾“å‡ºç»“æœ

### æ·±åº¦æŒ‡æ ‡
- `abs_rel`: å¹³å‡ç›¸å¯¹è¯¯å·®
- `sq_rel`: å¹³æ–¹ç›¸å¯¹è¯¯å·®
- `rmse`: å‡æ–¹æ ¹è¯¯å·® (m)
- `rmse_log`: å¯¹æ•°RMSE
- `a1, a2, a3`: Î´ < 1.25^n å‡†ç¡®ç‡

### ä½å§¿æŒ‡æ ‡
- `gate_rmse`: å…¨å±€ATE RMSE (m)
- `late_rmse_mean`: å±€éƒ¨ATE RMSEå¹³å‡å€¼ (m)
- `late_rmse_std`: å±€éƒ¨ATE RMSEæ ‡å‡†å·® (m)

### ç»“æœæ–‡ä»¶
- `complete_evaluation_results.json`: å®Œæ•´JSONç»“æœ
- `evaluation_summary.txt`: ç®€åŒ–æ–‡æœ¬æŠ¥å‘Š
- åŒ…å«æ¯å¸§è¯¦ç»†æ•°æ®å’Œå¤„ç†ç»Ÿè®¡ä¿¡æ¯

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰è¯„ä¼°å‚æ•°

```python
evaluator = UnifiedEvaluator(
    depth_min=0.01,          # è‡ªå®šä¹‰æ·±åº¦èŒƒå›´
    depth_max=100.0,
    pose_window_size=10,     # è‡ªå®šä¹‰L-ATEçª—å£å¤§å°
    verbose=False            # å…³é—­è¯¦ç»†è¾“å‡º
)
```

### æ ¼å¼ç‰¹å®šå‚æ•°

```python
# TIFFæ·±åº¦æ•°æ®è£å‰ª
results = evaluator.evaluate_depth_only(
    gt_depth_path="tiff_dir/",
    pred_depth_path="npy_dir/",
    gt_format='tiff_dir',
    pred_format='npy_dir',
    format_kwargs={
        'gt_kwargs': {'crop_rows': 1024}  # è£å‰ªå‰1024è¡Œ
    }
)

# æ–‡æœ¬ä½å§¿æ ¼å¼æŒ‡å®š
results = evaluator.evaluate_pose_only(
    gt_pose_path="poses.txt",
    pred_pose_path="pred_dir/",
    gt_format='txt_file',
    pred_format='npz_dir',
    format_kwargs={
        'gt_kwargs': {'format_type': 'kitti'}  # KITTIæ ¼å¼
    }
)
```

## ğŸ’¡ æœ€ä½³å®è·µ

### æ•°æ®å‡†å¤‡
1. **å•ä½ç»Ÿä¸€**: ç¡®ä¿æ·±åº¦å’Œä½å§¿æ•°æ®å•ä½æ­£ç¡®ï¼ˆæ¨èä½¿ç”¨ç±³ï¼‰
2. **æ ¼å¼è§„èŒƒ**: ä½å§¿ä½¿ç”¨cam2worldæ ¼å¼çš„4x4çŸ©é˜µ
3. **æ•°æ®éªŒè¯**: ä½¿ç”¨æ¡†æ¶çš„æ•°æ®éªŒè¯åŠŸèƒ½æ£€æŸ¥è¾“å…¥è´¨é‡

### è¯„ä¼°é…ç½®
1. **æ·±åº¦èŒƒå›´**: æ ¹æ®æ•°æ®é›†ç‰¹ç‚¹è°ƒæ•´æœ‰æ•ˆæ·±åº¦èŒƒå›´
2. **çª—å£å¤§å°**: L-ATEçª—å£å¤§å°å¯æ ¹æ®åºåˆ—é•¿åº¦è°ƒæ•´
3. **è¯¦ç»†è¾“å‡º**: é¦–æ¬¡ä½¿ç”¨æ—¶å¼€å¯verboseäº†è§£å¤„ç†è¿‡ç¨‹

### ç»“æœè§£è¯»
1. **æ·±åº¦æ€§èƒ½**: a1 > 0.8ä¸ºä¼˜ç§€ï¼Œ0.6-0.8ä¸ºè‰¯å¥½
2. **ä½å§¿æ€§èƒ½**: RMSE < 0.01mä¸ºä¼˜ç§€ï¼Œ0.01-0.05mä¸ºè‰¯å¥½
3. **æ•°æ®è´¨é‡**: æ³¨æ„å¤„ç†ç»Ÿè®¡ä¸­çš„æœ‰æ•ˆå¸§æ¯”ä¾‹å’Œç¼©æ”¾æ¯”ä¾‹

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. æ•°æ®åŠ è½½å¤±è´¥**
```
é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨ æˆ– æ ¼å¼ä¸æ”¯æŒ
è§£å†³: æ£€æŸ¥è·¯å¾„æ­£ç¡®æ€§ï¼Œä½¿ç”¨get_format_info()æ£€æµ‹æ ¼å¼
```

**2. æœ‰æ•ˆåƒç´ å¤ªå°‘**
```
é”™è¯¯: æœ‰æ•ˆåƒç´ æ•°å¤ªå°‘
è§£å†³: è°ƒæ•´æ·±åº¦èŒƒå›´å‚æ•°ï¼Œæ£€æŸ¥æ•°æ®è´¨é‡
```

**3. ä½å§¿å¯¹é½å¤±è´¥**
```
é”™è¯¯: èµ·ç‚¹å¯¹é½è¯¯å·®è¿‡å¤§
è§£å†³: æ£€æŸ¥ä½å§¿æ•°æ®æ ¼å¼ï¼Œç¡®è®¤ä¸ºcam2worldæ ¼å¼
```

**4. çª—å£è¯„ä¼°å¤±è´¥**
```
é”™è¯¯: æ²¡æœ‰æˆåŠŸè¯„ä¼°ä»»ä½•çª—å£
è§£å†³: æ£€æŸ¥åºåˆ—é•¿åº¦ï¼Œè°ƒæ•´çª—å£å¤§å°å‚æ•°
```

## ğŸ“š ç¤ºä¾‹æ•°æ®é›†

æ¡†æ¶å·²åœ¨ä»¥ä¸‹æ•°æ®é›†ä¸ŠéªŒè¯ï¼š
- **SCARED**: å†…çª¥é•œæ‰‹æœ¯æ•°æ®é›†
- **EndoDAC**: å†…çª¥é•œæ·±åº¦æ•°æ®é›†  
- **KITTI**: è‡ªåŠ¨é©¾é©¶æ•°æ®é›†

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜æŠ¥å‘Šå’Œæ”¹è¿›å»ºè®®ï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚

---

ğŸ‰ **ç»Ÿä¸€è¯„ä¼°ï¼Œæ ‡å‡†ä¸€è‡´ï¼Œç»“æœå¯ä¿¡ï¼**



